<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SiteBuilder</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- CORE LOGIC & STORAGE -->
    <script>
        const DB_KEY_PAGES = 'sitebuilder_pages';
        const DB_KEY_PLUGIN_STATE = 'sitebuilder_plugin_state';
        const DB_KEY_CUSTOM_PLUGINS = 'sitebuilder_custom_plugins';

        // --- 1. Pages API ---
        const Pages = {
            getAll: () => { const e = localStorage.getItem(DB_KEY_PAGES); return e ? JSON.parse(e) : []; },
            getById: e => Pages.getAll().find(t => t.id === e) || null,
            create: (data) => {
                const t = Pages.getAll();
                const a = { 
                    id: "page_" + Date.now(), 
                    title: data.title || "Untitled Page", 
                    slug: data.slug || "untitled-page",
                    status: data.status || "Draft", 
                    author: data.author || "Admin", 
                    lastModified: (new Date).toLocaleString(), 
                    widgets: [] 
                };
                t.push(a); localStorage.setItem(DB_KEY_PAGES, JSON.stringify(t)); return a;
            },
            update: (id, updates) => {
                const list = Pages.getAll(); 
                const idx = list.findIndex(p => p.id === id);
                if (idx !== -1) { 
                    list[idx] = { ...list[idx], ...updates, lastModified: (new Date).toLocaleString() }; 
                    localStorage.setItem(DB_KEY_PAGES, JSON.stringify(list)); 
                    return true; 
                } 
                return false;
            },
            trash: (id) => { 
                const list = Pages.getAll(); 
                const idx = list.findIndex(p => p.id === id); 
                if (idx !== -1) { list[idx].status = 'Trash'; localStorage.setItem(DB_KEY_PAGES, JSON.stringify(list)); } 
            },
            restore: (id) => { 
                const list = Pages.getAll(); 
                const idx = list.findIndex(p => p.id === id); 
                if (idx !== -1) { list[idx].status = 'Draft'; localStorage.setItem(DB_KEY_PAGES, JSON.stringify(list)); } 
            },
            delete: (id) => { 
                const list = Pages.getAll(); 
                const filtered = list.filter(p => p.id !== id); 
                localStorage.setItem(DB_KEY_PAGES, JSON.stringify(filtered)); 
            },
            duplicate: (id) => {
                const p = Pages.getById(id); 
                if (p) {
                    const list = Pages.getAll(); 
                    const copy = { ...p, id: "page_" + Date.now(), title: p.title + " (Copy)", status: "Draft", lastModified: (new Date).toLocaleString() };
                    list.push(copy); localStorage.setItem(DB_KEY_PAGES, JSON.stringify(list)); 
                    return copy;
                } 
                return null;
            }
        };

        // --- 2. Plugin System ---
        const PluginRepository = [
            { id: 'seo_pack', name: 'SEO Pro Pack', description: 'Comprehensive SEO tools.', version: '1.0', author: 'System', icon: 'fa-search', code: `Dashboard.registerMenu('seo', 'SEO', 'fa-search', (c) => c.innerHTML = '<h3>SEO Dashboard</h3><p>Optimize your content here.</p>');` },
            { id: 'analytics_pro', name: 'Analytics Pro', description: 'Traffic stats dashboard.', version: '2.0', author: 'DataSoft', icon: 'fa-chart-line', code: `Dashboard.registerMenu('analytics', 'Analytics', 'fa-chart-line', (c) => c.innerHTML = '<h3>Visitor Stats</h3><p>Chart placeholders...</p>');` },
            { id: 'woo_commerce', name: 'WooCommerce Lite', description: 'Online store functionality.', version: '1.5', author: 'Automattic', icon: 'fa-shopping-cart', code: `Dashboard.registerMenu('products', 'Products', 'fa-tag', (c) => c.innerHTML = '<h3>Products</h3>');` },
            { id: 'security_shield', name: 'Security Shield', description: 'Firewall and malware scan.', version: '3.1', author: 'SecureCo', icon: 'fa-shield-alt', code: `` },
            { id: 'contact_forms', name: 'Contact Forms', description: 'Drag and drop form builder.', version: '1.2', author: 'FormsInc', icon: 'fa-envelope', code: `` }
        ];

        const PluginSystem = {
            getCustomPlugins: () => { const s = localStorage.getItem(DB_KEY_CUSTOM_PLUGINS); return s ? JSON.parse(s) : []; },
            getAllInstalled: () => [...PluginSystem.getCustomPlugins()], // In real app, includes core files
            getState: () => { const s = localStorage.getItem(DB_KEY_PLUGIN_STATE); return s ? JSON.parse(s) : {}; },
            
            isInstalled: (id) => {
                // Check if in custom storage OR active state (simple check)
                const custom = PluginSystem.getCustomPlugins().some(p => p.id === id);
                return custom || PluginSystem.getState()[id] !== undefined;
            },
            isActive: (id) => !!PluginSystem.getState()[id],
            
            toggle: (id) => { 
                const s = PluginSystem.getState(); 
                s[id] = !s[id]; 
                localStorage.setItem(DB_KEY_PLUGIN_STATE, JSON.stringify(s)); 
                location.reload(); 
            },
            
            install: (meta, code) => {
                const c = PluginSystem.getCustomPlugins(); 
                const n = { ...meta, code, isCustom: true };
                // Update if exists, else push
                const idx = c.findIndex(p => p.id === n.id); 
                if(idx >= 0) c[idx] = n; else c.push(n);
                
                localStorage.setItem(DB_KEY_CUSTOM_PLUGINS, JSON.stringify(c));
                
                // Set state to inactive initially if new
                const s = PluginSystem.getState(); 
                if(s[n.id] === undefined) { s[n.id] = false; localStorage.setItem(DB_KEY_PLUGIN_STATE, JSON.stringify(s)); }
                return n;
            },
            
            delete: (id) => {
                const c = PluginSystem.getCustomPlugins().filter(p => p.id !== id); 
                localStorage.setItem(DB_KEY_CUSTOM_PLUGINS, JSON.stringify(c));
                const s = PluginSystem.getState(); delete s[id]; 
                localStorage.setItem(DB_KEY_PLUGIN_STATE, JSON.stringify(s)); 
                location.reload();
            },
            
            boot: () => {
                PluginSystem.getCustomPlugins().forEach(p => {
                    if (PluginSystem.isActive(p.id) && p.code) {
                        try { 
                            const fn = new Function('Dashboard', 'Pages', p.code); 
                            fn(window.Dashboard, window.Pages); 
                        } catch (e) { console.error(`Plugin ${p.name} error:`, e); }
                    }
                });
            }
        };

        // --- 3. Dashboard API ---
        const Dashboard = {
            menus: [],
            registerMenu: function(id, label, icon, renderCallback, order = 10) {
                this.menus = this.menus.filter(m => m.id !== id);
                this.menus.push({ id, label, icon, render: renderCallback, order });
                this.menus.sort((a, b) => a.order - b.order);
            },
            renderSidebar: function() {
                const c = document.getElementById('admin-sidebar-menu'); if(!c) return; c.innerHTML = '';
                this.menus.forEach(m => {
                    const i = document.createElement('div'); i.className = `sidebar-item ${currentView === m.id ? 'active' : ''}`;
                    i.innerHTML = `<i class="fas ${m.icon}"></i> ${m.label}`; i.onclick = () => Dashboard.switchView(m.id);
                    c.appendChild(i);
                });
            },
            switchView: function(viewId) {
                currentView = viewId; this.renderSidebar();
                const body = document.getElementById('wp-body-content'); body.innerHTML = '';
                const m = this.menus.find(x => x.id === viewId);
                
                // Hide actions by default
                document.getElementById('page-heading-action').style.display = 'none';
                document.getElementById('page-search-container').style.display = 'none';
                
                if(m && m.render) {
                    document.getElementById('page-heading-text').textContent = m.label;
                    m.render(body);
                }
            }
        };

        window.Pages = Pages; window.PluginSystem = PluginSystem; window.Dashboard = Dashboard;
    </script>

    <style>
        /* --- CSS --- */
        :root {
            --admin-bar-bg: #1d2327; --sidebar-bg: #2c3338; --sidebar-hover: #1d2327; --sidebar-active: #2271b1;
            --body-bg: #f0f0f1; --text-main: #3c434a; --border-color: #c3c4c7; --accent: #2271b1; --accent-hover: #135e96;
            --danger: #d63638; --success: #00a32a;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--body-bg); color: var(--text-main); display: flex; height: 100vh; font-size: 13px; }

        /* Sidebar & Admin Bar */
        .sidebar { width: 160px; background: var(--sidebar-bg); color: #fff; flex-shrink: 0; display: flex; flex-direction: column; }
        .sidebar-brand { padding: 15px 12px; font-weight: 600; background: #1d2327; color: #fff; display: flex; align-items: center; gap: 8px; }
        .sidebar-item { display: flex; align-items: center; padding: 10px 12px; color: #f0f0f1; text-decoration: none; transition: 0.1s; cursor: pointer; }
        .sidebar-item:hover, .sidebar-item.active { background: var(--sidebar-hover); color: #fff; }
        .sidebar-item.active { font-weight: 600; border-left: 4px solid var(--accent); background: #101010; }
        .sidebar-item i { width: 20px; margin-right: 8px; opacity: 0.8; text-align: center; }
        
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .admin-bar { height: 32px; background: var(--admin-bar-bg); display: flex; align-items: center; padding: 0 15px; color: #fff; justify-content: space-between; }
        
        /* Body Area */
        .wp-body { padding: 20px; overflow-y: auto; flex: 1; }
        .wp-header { display: flex; align-items: center; margin-bottom: 20px; gap: 15px; height: 30px; }
        .wp-heading { font-size: 23px; font-weight: 400; color: #1d2327; margin: 0; }
        
        .page-title-action {
            text-decoration: none; font-size: 13px; line-height: 2; padding: 0 10px; cursor: pointer; border: 1px solid var(--accent); border-radius: 3px;
            color: var(--accent); background: #f6f7f7; vertical-align: top; display: none;
        }
        .page-title-action:hover { background: #f0f0f1; border-color: var(--accent-hover); color: var(--accent-hover); }

        /* Tables */
        .tablenav { clear: both; height: 30px; margin: 6px 0 10px; vertical-align: middle; }
        .tablenav .actions { padding: 2px 8px 0 0; float: left; display: flex; gap: 6px; }
        .tablenav select { font-size: 13px; line-height: 2; color: #2c3338; border-color: #8c8f94; border-radius: 3px; padding: 0 24px 0 8px; min-height: 30px; }
        
        .wp-list-table { width: 100%; border: 1px solid #c3c4c7; background: #fff; border-spacing: 0; margin-top: 5px; }
        .wp-list-table th, .wp-list-table td { text-align: left; padding: 8px 10px; border-bottom: 1px solid #f0f0f1; vertical-align: top; }
        .wp-list-table th { font-weight: 400; color: #1d2327; border-bottom: 1px solid #c3c4c7; }
        .wp-list-table tbody tr:hover { background-color: #f6f7f7; }
        .wp-list-table tr.active-plugin-row { background-color: #f0f6fc; border-left: 4px solid var(--accent); }
        .wp-list-table tr.active-plugin-row th, .wp-list-table tr.active-plugin-row td { background-color: #f0f6fc; }

        .row-title { color: var(--accent); font-weight: 600; font-size: 14px; text-decoration: none; cursor: pointer; }
        .row-actions { visibility: hidden; margin-top: 4px; font-size: 12px; }
        .wp-list-table tr:hover .row-actions { visibility: visible; }
        .action-link { color: var(--accent); cursor: pointer; margin-right: 5px; }
        .action-link:hover { color: var(--accent-hover); }
        .action-delete { color: #a00; }
        .action-delete:hover { color: var(--danger); }

        /* Quick Edit & Modals */
        .inline-edit-row { background-color: #f9f9f9; display: none; }
        .inline-edit-row.active { display: table-row; }
        .inline-edit-wrapper { padding: 10px; border-bottom: 1px solid #ddd; overflow: hidden; font-size: 13px; }
        .inline-edit-col { float: left; width: 48%; margin-right: 2%; }
        .inline-edit-group { margin-bottom: 8px; }
        .inline-edit-group label { display: block; margin-bottom: 4px; color: #1d2327; font-weight: 500; }
        .inline-edit-group input, .inline-edit-group select { width: 100%; max-width: 300px; height: 28px; border: 1px solid #8c8f94; border-radius: 3px; padding: 0 5px; }

        /* Filters & Search */
        .filter-links { margin-bottom: 10px; float: left; color: #555; }
        .filter-links a { color: #0073aa; text-decoration: none; cursor: pointer; }
        .filter-links .current { color: #000; font-weight: 600; }
        .search-box { float: right; margin-bottom: 10px; display: none; } /* Hidden by default */
        .search-box input { padding: 0 8px; line-height: 2; min-height: 30px; border: 1px solid #8c8f94; border-radius: 3px; }

        /* Plugin Card Grid */
        .plugin-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-top: 15px; }
        .plugin-card { border: 1px solid #c3c4c7; background: #fff; box-shadow: 0 1px 1px rgba(0,0,0,0.04); display: flex; flex-direction: column; }
        .plugin-card-top { padding: 20px; display: flex; gap: 15px; flex-grow: 1; }
        .plugin-icon { width: 64px; height: 64px; background: #f0f0f1; display: flex; align-items: center; justify-content: center; font-size: 28px; color: #555; }
        .plugin-card-body h3 { margin: 0 0 8px; font-size: 16px; color: #1d2327; }
        .plugin-card-bottom { background: #f6f7f7; padding: 12px 20px; border-top: 1px solid #c3c4c7; display: flex; justify-content: space-between; align-items: center; }

        /* Modal Overlay */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: #fff; width: 600px; max-width: 90%; border-radius: 4px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column;
        }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 18px; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; background: #f6f7f7; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }

        /* Utilities */
        .button { background: #fff; color: #2271b1; border: 1px solid #2271b1; padding: 4px 10px; border-radius: 3px; cursor: pointer; font-size: 13px; min-height: 30px; }
        .button:hover { background: #f0f0f1; border-color: #0a4b78; color: #0a4b78; }
        .button-primary { background: #2271b1; color: #fff; border-color: #2271b1; }
        .button-primary:hover { background: #135e96; color: #fff; }
        .status-badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: 500; }
        .status-published { background: #d6fde7; color: #005a2b; }
        .status-draft { background: #f0f0f1; color: #646970; }
        .upload-area { border: 2px dashed #c3c4c7; padding: 30px; text-align: center; color: #646970; margin-bottom: 20px; display: none; }
        .upload-area.active { display: block; }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-brand"><i class="fas fa-layer-group"></i> Dashboard</div>
        <div id="admin-sidebar-menu"></div>
    </div>

    <!-- Main -->
    <div class="main-content">
        <div class="admin-bar">
            <div><i class="fab fa-wordpress"></i> My Site</div>
            <div>Howdy, User</div>
        </div>
        <div class="wp-body">
            <div class="wp-header">
                <h1 class="wp-heading" id="page-heading-text">Dashboard</h1>
                <div class="search-box" id="page-search-container">
                    <input type="search" id="global-search-input" placeholder="Search...">
                    <button class="button" id="global-search-btn">Search</button>
                </div>
                <button class="page-title-action" id="page-heading-action">Add New</button>
            </div>
            <div id="wp-body-content"></div>
        </div>
    </div>

    <!-- MODAL: Page Settings -->
    <div id="page-settings-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Page Settings</h3>
                <button class="button" style="border:none;background:none;font-size:20px;" onclick="closePageModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-page-id">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="edit-page-title" class="inline-edit-group input" style="width:100%;height:30px;" oninput="generateSlug(this.value)">
                </div>
                <div class="form-group">
                    <label>Slug</label>
                    <input type="text" id="edit-page-slug" class="inline-edit-group input" style="width:100%;height:30px;">
                </div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <div style="flex:1">
                        <label>Status</label><br>
                        <select id="edit-page-status" style="width:100%;height:30px;">
                            <option value="Published">Published</option>
                            <option value="Draft">Draft</option>
                        </select>
                    </div>
                    <div style="flex:1">
                        <label>Author</label><br>
                        <select id="edit-page-author" style="width:100%;height:30px;">
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button" onclick="closePageModal()">Cancel</button>
                <button class="button button-primary" onclick="savePageModal(false)">Save Settings</button>
                <button class="button button-primary" onclick="savePageModal(true)"><i class="fas fa-edit"></i> Edit with Editor</button>
            </div>
        </div>
    </div>

    <!-- HIDDEN UPLOAD -->
    <input type="file" id="plugin-file-upload" accept=".js" style="display:none;" onchange="handlePluginUpload(event)">

    <script>
        let currentView = 'pages';
        let pageFilter = 'all';
        let pluginFilter = 'all';
        let searchQuery = '';

        document.addEventListener('DOMContentLoaded', () => {
            initDashboard();
        });

        function initDashboard() {
            // Register Menus
            Dashboard.registerMenu('dashboard', 'Dashboard', 'fa-tachometer-alt', renderDashboardHome, 1);
            Dashboard.registerMenu('pages', 'Pages', 'fa-file-alt', renderPagesView, 2);
            Dashboard.registerMenu('plugins', 'Plugins', 'fa-plug', renderPluginsView, 90);
            Dashboard.registerMenu('settings', 'Settings', 'fa-cog', renderSettingsView, 100);
            
            PluginSystem.boot();
            Dashboard.renderSidebar();
            Dashboard.switchView('pages');
        }

        // --- 1. PAGES VIEW ---
        function renderPagesView(container) {
            // Header Setup
            document.getElementById('page-heading-action').style.display = 'inline-block';
            document.getElementById('page-heading-action').textContent = 'Add New';
            document.getElementById('page-heading-action').onclick = () => openPageModal(null);
            
            // Search Setup
            const searchBox = document.getElementById('page-search-container');
            searchBox.style.display = 'block';
            document.getElementById('global-search-btn').onclick = () => {
                searchQuery = document.getElementById('global-search-input').value;
                renderPagesTable(container);
            };

            renderPagesTable(container);
        }

        function renderPagesTable(container) {
            // Logic
            let pages = Pages.getAll();
            const counts = {
                all: pages.filter(p=>p.status!=='Trash').length,
                published: pages.filter(p=>p.status==='Published').length,
                draft: pages.filter(p=>p.status==='Draft').length,
                trash: pages.filter(p=>p.status==='Trash').length
            };

            // Filters
            if (pageFilter === 'all') pages = pages.filter(p => p.status !== 'Trash');
            else pages = pages.filter(p => p.status === pageFilter);
            if (searchQuery) pages = pages.filter(p => p.title.toLowerCase().includes(searchQuery.toLowerCase()));

            // UI Construction
            let html = `
                <div class="filter-links">
                    <a onclick="setPageFilter('all')" class="${pageFilter==='all'?'current':''}">All (${counts.all})</a> |
                    <a onclick="setPageFilter('Published')" class="${pageFilter==='Published'?'current':''}">Published (${counts.published})</a> |
                    <a onclick="setPageFilter('Draft')" class="${pageFilter==='Draft'?'current':''}">Drafts (${counts.draft})</a> |
                    <a onclick="setPageFilter('Trash')" class="${pageFilter==='Trash'?'current':''}">Trash (${counts.trash})</a>
                </div>
                <div class="tablenav top">
                    <div class="actions">
                        <select id="bulk-action-pages">
                            <option value="-1">Bulk actions</option>
                            ${pageFilter === 'Trash' ? '<option value="restore">Restore</option><option value="delete">Delete Permanently</option>' : '<option value="trash">Move to Trash</option>'}
                        </select>
                        <button class="button" onclick="handleBulkPages()">Apply</button>
                    </div>
                </div>
                <table class="wp-list-table">
                    <thead><tr><th style="width:30px"><input type="checkbox" onclick="toggleAllChecks(this)"></th><th>Title</th><th>Author</th><th>Status</th><th>Date</th></tr></thead>
                    <tbody>
            `;

            if(pages.length === 0) html += `<tr><td colspan="5">No pages found.</td></tr>`;
            else {
                pages.forEach(p => {
                    const statusClass = p.status === 'Published' ? 'status-published' : 'status-draft';
                    let actions = '';
                    if(p.status === 'Trash') {
                        actions = `<span class="action-link" onclick="Pages.restore('${p.id}'); Dashboard.switchView('pages');">Restore</span> | <span class="action-link action-delete" onclick="Pages.delete('${p.id}'); Dashboard.switchView('pages');">Delete Permanently</span>`;
                    } else {
                        actions = `
                            <span class="action-link" onclick="openPageModal('${p.id}')">Edit</span> | 
                            <span class="action-link" onclick="toggleQuickEdit('${p.id}')">Quick&nbsp;Edit</span> | 
                            <span class="action-link action-delete" onclick="Pages.trash('${p.id}'); Dashboard.switchView('pages');">Trash</span> | 
                            <span class="action-link" onclick="window.location.href='builder.html?page=${p.id}'">Edit&nbsp;With&nbsp;Editor</span>
                        `;
                    }

                    html += `
                        <tr id="row-${p.id}">
                            <td><input type="checkbox" class="bulk-check" value="${p.id}"></td>
                            <td>
                                <strong><a class="row-title" onclick="openPageModal('${p.id}')">${p.title}</a></strong>
                                <div class="row-actions">${actions}</div>
                            </td>
                            <td>${p.author}</td>
                            <td><span class="status-badge ${statusClass}">${p.status}</span></td>
                            <td>${p.lastModified}</td>
                        </tr>
                        <tr id="quick-edit-${p.id}" class="inline-edit-row">
                            <td colspan="5">
                                <div class="inline-edit-wrapper">
                                    <h4>QUICK EDIT</h4>
                                    <div style="display:flex; gap:10px;">
                                        <div style="flex:1">
                                            <label>Title</label><br><input type="text" id="qe-title-${p.id}" value="${p.title}" style="width:100%">
                                        </div>
                                        <div style="flex:1">
                                            <label>Slug</label><br><input type="text" value="${p.slug}" disabled style="width:100%">
                                        </div>
                                        <div style="flex:1">
                                            <label>Status</label><br>
                                            <select id="qe-status-${p.id}" style="width:100%">
                                                <option value="Published" ${p.status==='Published'?'selected':''}>Published</option>
                                                <option value="Draft" ${p.status==='Draft'?'selected':''}>Draft</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div style="margin-top:10px;">
                                        <button class="button button-primary" onclick="saveQuickEdit('${p.id}')">Update</button>
                                        <button class="button" onclick="toggleQuickEdit('${p.id}')">Cancel</button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            html += `</tbody><tfoot><tr><th><input type="checkbox"></th><th>Title</th><th>Author</th><th>Status</th><th>Date</th></tr></tfoot></table>`;
            container.innerHTML = html;
        }

        // --- 2. PLUGINS VIEW ---
        function renderPluginsView(container) {
            const btn = document.getElementById('page-heading-action');
            btn.style.display = 'inline-block';
            btn.textContent = 'Add New';
            btn.onclick = () => renderPluginRepo(container);

            const all = PluginSystem.getAllInstalled();
            const counts = { 
                all: all.length, 
                active: all.filter(p => PluginSystem.isActive(p.id)).length,
                inactive: all.filter(p => !PluginSystem.isActive(p.id)).length 
            };

            let display = all;
            if(pluginFilter === 'active') display = display.filter(p => PluginSystem.isActive(p.id));
            if(pluginFilter === 'inactive') display = display.filter(p => !PluginSystem.isActive(p.id));

            let html = `
                <div class="filter-links">
                    <a onclick="setPluginFilter('all')" class="${pluginFilter==='all'?'current':''}">All (${counts.all})</a> |
                    <a onclick="setPluginFilter('active')" class="${pluginFilter==='active'?'current':''}">Active (${counts.active})</a> |
                    <a onclick="setPluginFilter('inactive')" class="${pluginFilter==='inactive'?'current':''}">Inactive (${counts.inactive})</a>
                </div>
                <div class="tablenav top">
                    <div class="actions">
                        <select id="bulk-action-plugins">
                            <option value="-1">Bulk actions</option>
                            <option value="activate">Activate</option>
                            <option value="deactivate">Deactivate</option>
                            <option value="delete">Delete</option>
                        </select>
                        <button class="button" onclick="handleBulkPlugins()">Apply</button>
                    </div>
                </div>
                <table class="wp-list-table">
                    <thead><tr><th style="width:30px"><input type="checkbox" onclick="toggleAllChecks(this)"></th><th>Plugin</th><th>Description</th></tr></thead>
                    <tbody>
            `;

            if(display.length === 0) html += `<tr><td colspan="3">No plugins found.</td></tr>`;
            else {
                display.forEach(p => {
                    const active = PluginSystem.isActive(p.id);
                    const rowClass = active ? 'active-plugin-row' : '';
                    html += `
                        <tr class="${rowClass}">
                            <td><input type="checkbox" class="bulk-check" value="${p.id}"></td>
                            <td>
                                <strong>${p.name}</strong>
                                <div class="row-actions">
                                    ${active ? `<span class="action-link" onclick="PluginSystem.toggle('${p.id}')">Deactivate</span>` : `<span class="action-link" onclick="PluginSystem.toggle('${p.id}')">Activate</span>`}
                                    | <span class="action-link action-delete" onclick="PluginSystem.delete('${p.id}')">Delete</span>
                                </div>
                            </td>
                            <td><p>${p.description}</p><small>Version ${p.version} | By ${p.author}</small></td>
                        </tr>
                    `;
                });
            }
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function renderPluginRepo(container) {
            document.getElementById('page-heading-text').innerHTML = `Add Plugins <button class="page-title-action" onclick="document.getElementById('upload-area').classList.toggle('active')" style="display:inline-block">Upload Plugin</button>`;
            document.getElementById('page-heading-action').style.display = 'none';

            let html = `
                <div id="upload-area" class="upload-area">
                    <h3>Upload Plugin</h3>
                    <p>If you have a plugin in a .js file format, you can install it by uploading it here.</p>
                    <button class="button" onclick="document.getElementById('plugin-file-upload').click()">Choose File</button>
                </div>
                <div class="filter-links" style="margin-bottom:20px; border-bottom:1px solid #ddd; padding-bottom:10px; width:100%;">
                    <a class="current">Featured</a> <a>Popular</a> <a>Recommended</a>
                </div>
                <div class="plugin-grid">
            `;

            PluginRepository.forEach(p => {
                const installed = PluginSystem.isInstalled(p.id);
                const active = PluginSystem.isActive(p.id);
                let btn = '';
                if(active) btn = `<button class="button disabled">Active</button>`;
                else if(installed) btn = `<button class="button" onclick="PluginSystem.toggle('${p.id}')">Activate</button>`;
                else btn = `<button class="button" onclick="installRepoPlugin('${p.id}')">Install Now</button>`;

                html += `
                    <div class="plugin-card">
                        <div class="plugin-card-top">
                            <div class="plugin-icon"><i class="fas ${p.icon}"></i></div>
                            <div class="plugin-card-body"><h3>${p.name}</h3><p>${p.description}</p></div>
                        </div>
                        <div class="plugin-card-bottom">${btn}</div>
                    </div>
                `;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        // --- 3. PAGE ACTIONS ---
        function setPageFilter(f) { pageFilter = f; Dashboard.switchView('pages'); }
        function openPageModal(id) {
            const m = document.getElementById('page-settings-modal');
            const p = id ? Pages.getById(id) : { title:'', slug:'', status:'Draft', id:'' };
            
            document.getElementById('edit-page-id').value = p.id || '';
            document.getElementById('edit-page-title').value = p.title;
            document.getElementById('edit-page-slug').value = p.slug;
            document.getElementById('edit-page-status').value = p.status;
            m.classList.add('active');
        }
        function closePageModal() { document.getElementById('page-settings-modal').classList.remove('active'); }
        function savePageModal(goEditor) {
            const id = document.getElementById('edit-page-id').value;
            const data = {
                title: document.getElementById('edit-page-title').value,
                slug: document.getElementById('edit-page-slug').value,
                status: document.getElementById('edit-page-status').value
            };
            let pid = id;
            if(id) Pages.update(id, data); else pid = Pages.create(data).id;
            
            closePageModal();
            if(goEditor) window.location.href = `builder.html?page=${pid}`;
            else Dashboard.switchView('pages');
        }
        function generateSlug(v) { 
            if(!document.getElementById('edit-page-id').value) 
                document.getElementById('edit-page-slug').value = v.toLowerCase().replace(/ /g,'-').replace(/[^\w-]+/g,''); 
        }
        function toggleQuickEdit(id) { document.getElementById(`quick-edit-${id}`).classList.toggle('active'); }
        function saveQuickEdit(id) {
            Pages.update(id, {
                title: document.getElementById(`qe-title-${id}`).value,
                status: document.getElementById(`qe-status-${id}`).value
            });
            Dashboard.switchView('pages');
        }
        function toggleAllChecks(src) { document.querySelectorAll('.bulk-check').forEach(c => c.checked = src.checked); }
        function handleBulkPages() {
            const act = document.getElementById('bulk-action-pages').value;
            if(act === '-1') return;
            const ids = Array.from(document.querySelectorAll('.bulk-check:checked')).map(c=>c.value);
            ids.forEach(id => {
                if(act==='trash') Pages.trash(id);
                if(act==='delete') Pages.delete(id);
                if(act==='restore') Pages.restore(id);
            });
            Dashboard.switchView('pages');
        }

        // --- 4. PLUGIN ACTIONS ---
        function setPluginFilter(f) { pluginFilter = f; Dashboard.switchView('plugins'); }
        function handleBulkPlugins() {
            const act = document.getElementById('bulk-action-plugins').value;
            if(act==='-1') return;
            const ids = Array.from(document.querySelectorAll('.bulk-check:checked')).map(c=>c.value);
            ids.forEach(id => {
                if(act==='activate' && !PluginSystem.isActive(id)) PluginSystem.toggle(id);
                if(act==='deactivate' && PluginSystem.isActive(id)) PluginSystem.toggle(id);
                if(act==='delete') PluginSystem.delete(id);
            });
            if(act!=='delete') location.reload(); // State change requires reload
        }
        function installRepoPlugin(id) {
            const p = PluginRepository.find(x=>x.id===id);
            if(p) { PluginSystem.install(p, p.code); renderPluginRepo(document.getElementById('wp-body-content')); }
        }
        function handlePluginUpload(e) {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader(); r.onload = (ev) => {
                PluginSystem.install({ id: f.name, name: f.name, description: 'Uploaded', version:'1.0' }, ev.target.result);
                alert('Plugin Installed'); Dashboard.switchView('plugins');
            }; r.readAsText(f);
        }

        // --- 5. RENDERERS ---
        function renderDashboardHome(c) { c.innerHTML='<div style="background:#fff;padding:20px;border:1px solid #ddd"><h3>Welcome</h3><p>SiteBuilder Dashboard Ready.</p></div>'; }
        function renderSettingsView(c) { c.innerHTML='<p>Settings placeholder.</p>'; }

    </script>
</body>
</html>